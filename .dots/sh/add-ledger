#!/usr/bin/env bash
#

source ./repo-functions.sh

PSYS="${HOME}/Repos/system"
mkdir -p "${PSYS}"

if [[ -x "${PSYS}/ledger/acprep" ]]; then
    echo "Found local ledger repository..."
    cd "${PSYS}/ledger" || { echo "Unable to enter local repository." >&2; exit 1; }
    ./acprep opt update
else
    get_or_update "${PSYS}"/ledger ledger/ledger master
    if (( UPDATED > 0 )); then
        cd "${PSYS}/ledger" || { echo "Unable to enter local repository." >&2; exit 1; }
        ./acprep opt update
    fi
fi

DEST="${HOME}/.dots/bin/ledger"
if [[ -x "${PSYS}/ledger/ledger" ]]; then
    [[ -L "${DEST}" ]] && rm "${DEST}"
    ln -sn "${PSYS}/ledger/ledger" "${DEST}"
else
    echo "Installation failed... ledger cannot be added to path" >&2
    exit 1
fi

get_or_update "${PSYS}"/ledger-mode ledger/ledger-mode master
if (( UPDATED > 0 )); then
    cd "${PSYS}/ledger-mode" || { echo "Unable to enter local repository" >&2; exit 1; }
    mkdir build
    cp ./*.el build
    emacs -batch --eval '(package-initialize)' -f batch-byte-compile ./build/*.el
    mv ./build "${HOME}/.config/emacs/pkgs/ledger"
fi
